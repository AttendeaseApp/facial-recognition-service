name: UNIT TESTS

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]

permissions:
    contents: read
    pull-requests: write

jobs:
    lint:
        name: Code Quality & Linting
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install linting dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8 black isort mypy

            - name: Check code formatting with Black
              run: |
                  black --check --line-length 100 src/ tests/
              continue-on-error: true

            - name: Check import sorting with isort
              run: |
                  isort --check-only --profile black src/ tests/
              continue-on-error: true

            - name: Lint with flake8
              run: |
                  # Stop the build if there are Python syntax errors or undefined names
                  flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Treat all errors as warnings
                  flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics --exclude=__pycache__,*.pyc,.git

            - name: Type check with mypy
              run: |
                  pip install types-Pillow types-requests
                  mypy src/ --ignore-missing-imports --no-strict-optional
              continue-on-error: true

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.10", "3.11", "3.12"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y cmake build-essential libopenblas-dev liblapack-dev libx11-dev

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip setuptools wheel
                  # Install application dependencies first
                  if [ -f dev-requirements.txt ]; then pip install -r dev-requirements.txt; fi
                  # Then install test dependencies
                  pip install pytest pytest-asyncio pytest-cov pytest-xdist
                  if [ -f dev-requirements.txt ]; then pip install -r dev-requirements-dev.txt; fi

            - name: Verify critical installations
              run: |
                  python -c "import numpy; print(f'numpy {numpy.__version__}')" || echo "numpy missing"
                  python -c "import face_recognition; print('face_recognition installed')" || echo "face_recognition missing"
                  python -c "import PIL; print('PIL installed')" || echo "PIL missing"
                  python -c "import pytest; print('pytest installed')" || echo "pytest missing"

            - name: Run tests with pytest
              run: |
                  pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing --maxfail=5

            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
              continue-on-error: true

            - name: Archive coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report-${{ matrix.python-version }}
                  path: htmlcov/
                  retention-days: 7

    security:
        name: Security Scan
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install safety bandit
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

            - name: Run safety check
              run: |
                  safety check --json || true
              continue-on-error: true

            - name: Run bandit security scan
              run: |
                  bandit -r src/ -f json -o bandit-report.json || true
                  bandit -r src/ -ll
              continue-on-error: true

            - name: Upload security reports
              uses: actions/upload-artifact@v4
              with:
                  name: security-reports
                  path: |
                      bandit-report.json
                  retention-days: 30
              if: always()

    integration:
        name: Integration Tests
        runs-on: ubuntu-latest
        needs: [test]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                  pip install httpx pytest-asyncio

            - name: Start FastAPI server
              run: |
                  uvicorn main:app --host 0.0.0.0 --port 8000 &
                  sleep 5
              continue-on-error: true

            - name: Run health check endpoint tests
              run: |
                  curl -f http://localhost:8000/health/status || exit 1
                  curl -f http://localhost:8000/ || exit 1
              continue-on-error: true

            - name: Run API endpoint tests
              run: |
                  python -c "import httpx; r = httpx.get('http://localhost:8000/health/status'); assert r.status_code == 200"
              continue-on-error: true

    summary:
        name: Test Summary
        runs-on: ubuntu-latest
        needs: [lint, test, security]
        if: always()

        steps:
            - name: Check results
              run: |
                  echo "Lint status: ${{ needs.lint.result }}"
                  echo "Test status: ${{ needs.test.result }}"
                  echo "Security status: ${{ needs.security.result }}"

                  if [ "${{ needs.test.result }}" != "success" ]; then
                    echo "Tests failed!"
                    exit 1
                  fi

                  if [ "${{ needs.lint.result }}" != "success" ]; then
                    echo "Linting issues found (non-blocking)"
                  fi

                  echo "All critical checks passed!"
